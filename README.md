# Домашнее задание к занятию 3.3. Операционные системы, лекция 2  

## 1. На лекции мы познакомились с node_exporter. В демонстрации его исполняемый файл запускался в background. Этого достаточно для демо, но не для настоящей production-системы, где процессы должны находиться под внешним управлением.   

установка : сделано по https://linuxoid.pro/kak-svyazat-node-exporter-s-prometheus-polnoe-rukovodstvo/  
кроме Grafana.   

### Используя знания из лекции по systemd, создайте самостоятельно простой unit-файл для node_exporter:    

###     а) поместите его в автозагрузку;   
	-сделано:   
	 sudo systemctl enable node_exporter   

###     б) предусмотрите возможность добавления опций к запускаемому процессу через внешний файл (посмотрите, например, на systemctl cat cron);   
	сделано, текст юнита:   
[Unit]   
Description=Node Exporter   
After=network-online.target    

[Service]   
User=node_exporter   
Group=node_exporter   
Type=simple   
ExecStart=/usr/local/bin/node_exporter   
EnvironmentFile=/etc/default/node_exporter   

[Install]   
WantedBy=multi-user.target   
###     в) удостоверьтесь, что с помощью systemctl процесс корректно стартует, завершается, а после перезагрузки автоматически поднимается.   
старт	https://disk.yandex.ru/i/6lgRpUqNjy-QEA  
переменные окружения https://disk.yandex.ru/i/4NVLqBkr-q_ILQ  
стоп и старт  https://disk.yandex.ru/i/7LZD5lOvIRUreQ  
после  ребута https://disk.yandex.ru/i/uM38dphw6xWYmQ  

## 2. Ознакомьтесь с опциями node_exporter и выводом /metrics по-умолчанию. Приведите несколько опций, которые вы бы выбрали для базового мониторинга хоста по CPU, памяти, диску и сети.  
CPU:  
\# HELP node_cpu_seconds_total Seconds the cpus spent in each mode.  
\# TYPE node_cpu_seconds_total counter  
node_cpu_seconds_total{cpu="0",mode="idle"} 530.76  
node_cpu_seconds_total{cpu="1",mode="system"} 1.79  
node_cpu_seconds_total{cpu="1",mode="user"} 0.8  
  
Disk:  
node_disk_io_time_seconds_total{device="sda"} 2.912  
node_disk_read_bytes_total{device="sda"} 1.92545792e+08  
node_disk_read_time_seconds_total{device="sda"} 3.201  
node_disk_write_time_seconds_total{device="sda"} 0.398  

Memory:  
node_memory_MemAvailable_bytes 1.828589568e+09  
node_memory_MemTotal_bytes 2.08408576e+09  

Network:  
node_network_receive_errs_total{device="eth0"} 0  
node_network_receive_bytes_total{device="eth0"} 119383  
node_network_transmit_bytes_total{device="eth0"} 161077  
node_network_transmit_errs_total{device="eth0"} 0  

## 3. Установите в свою виртуальную машину Netdata. Воспользуйтесь готовыми пакетами для установки (sudo apt install -y netdata). После успешной установки:

    в конфигурационном файле /etc/netdata/netdata.conf в секции [web] замените значение с localhost на bind to = 0.0.0.0 ,
    добавьте в Vagrantfile проброс порта Netdata на свой локальный компьютер и сделайте vagrant reload:

config.vm.network "forwarded_port", guest: 19999, host: 19999

### После успешной перезагрузки в браузере на своем ПК (не в виртуальной машине) вы должны суметь зайти на localhost:19999. Ознакомьтесь с метриками, которые по умолчанию собираются Netdata и с комментариями, которые даны к этим метрикам.  

Сделано https://disk.yandex.ru/i/qH4f3Q6KTDhVvA    

## 4. Можно ли по выводу dmesg понять, осознает ли ОС, что загружена не на настоящем оборудовании, а на системе виртуализации?  

Да, можно ищем что нибудь про виртуализацию. Я вывел в файл и просматривал в удобном себе виде:   
https://disk.yandex.ru/i/gkBWUAXGOOYdrA  

## 5. Как настроен sysctl fs.nr_open на системе по-умолчанию? Узнайте, что означает этот параметр. Какой другой существующий лимит не позволит достичь такого числа (ulimit --help)?   

nr_open   Это означает максимальное количество дескрипторов файлов, которое может выделить процесс. Значение по умолчанию (кратно 1024) - 1024 * 1024 (1048576).   
file-nr  Количество выделенных файловых дескрипторов.    
file-max   Максимальное количество дескрипторов файлов, которые может создать и обрабатывать ядро. По умолчанию установлено значение 10 % от обшего объема оперативной памяти.    

ulimit  Изменяет ограничения ресурсов оболочки.  
	Параметры:  
        -S использовать "мягкий" лимит ресурсов  
        -H использовать "жесткий" лимит ресурсов  
	-n максимальное количество открытых файловых дескрипторов  

Тогда:  
ulimit  -Sn  "мягкий" лимит открытых файловых дескрипторов  
ulimit  -Hn  "жесткий" лимит открытых файловых дескрипторов  
Как я понимаю выделить большее количество чем указано в file-max нельзя.  
Мой вывод по лимтам:   
ulimit -Sn   
1024   
ulimit -Hn   
1048576  

## 6. Запустите любой долгоживущий процесс (не ls, который отработает мгновенно, а, например, sleep 1h) в отдельном неймспейсе процессов; покажите, что ваш процесс работает под PID 1 через nsenter. Для простоты работайте в данном задании под root (sudo -i). Под обычным пользователем требуются дополнительные опции (--map-root-user) и т.д.  

Со sleep не получилось почему то, взял bash.  
ну а дальше как в лекции:   
https://disk.yandex.ru/i/vt8y33ZBP58Fog  
https://disk.yandex.ru/i/WsUQW7a-_qoXMQ  

## 7. Найдите информацию о том, что такое :(){ :|:& };:. Запустите эту команду в своей виртуальной машине Vagrant с Ubuntu 20.04 (это важно, поведение в других ОС не проверялось). Некоторое время все будет "плохо", после чего (минуты) – ОС должна стабилизироваться. Вызов dmesg расскажет, какой механизм помог автоматической стабилизации. Как настроен этот механизм по-умолчанию, и как изменить число процессов, которое можно создать в сессии?   

Из нагугленого:  
:(){ :|:& };:  логическя бомба (fork bomb). Она оперирует определением функции с именем ‘:‘, которая вызывает сама себя дважды: один раз на переднем плане и один раз в фоне. Она продолжает своё выполнение снова и снова, пока Не забьется вся память системы и система не зависнет. 
Вот она же но в другом виде:  
    fu() {  
    fu | fu &  
    }  
    fu  

Чтобы это предотвратить можно ограничить число процессов на пользователя :  
ulimit -u 40  (ограничение в 40 процессов на пользовотеля)  

Стабилизировать  помог:  
[ 1120.291085] cgroup: fork rejected by pids controller in /user.slice/user-1000.slice/session-3.scope  
Как я понимаю это механизм ядра , который позволяет управлять использованием системных ресурсов, при превышении ограничения включается блокировка на создание новых ресурсов.  
В  systemctl show crond.service есть параметр для максимального количества задач, у меня он имеет такое значение:  
TasksMax=2279  
Если верно понял то можно изменить дефолтные значения для количества процессов в /etc/systemd/system.conf  





