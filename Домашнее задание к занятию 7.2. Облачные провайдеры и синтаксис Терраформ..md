# Домашнее задание к занятию 7.2. Облачные провайдеры и синтаксис Терраформ.

Домашнее задание к занятию "7.2. Облачные провайдеры и синтаксис Terraform."

Зачастую разбираться в новых инструментах гораздо интересней понимая то, как они работают изнутри. Поэтому в рамках первого необязательного задания предлагается завести свою учетную запись в AWS (Amazon Web Services) или Yandex.Cloud. Идеально будет познакомится с обоими облаками, потому что они отличаются.

## Задача 1 (Вариант с Yandex.Cloud). Регистрация в ЯО и знакомство с основами (необязательно, но крайне желательно).

<details>
    <summary>Задание 1</summary>	

    Подробная инструкция на русском языке содержится здесь https://cloud.yandex.ru/docs/solutions/infrastructure-management/terraform-quickstart.
    Обратите внимание на период бесплатного использования после регистрации аккаунта.
    Используйте раздел "Подготовьте облако к работе" для регистрации аккаунта. Далее раздел "Настройте провайдер" для подготовки базового терраформ конфига.
    Воспользуйтесь инструкцией( https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs ) на сайте терраформа, что бы не указывать авторизационный токен в коде, а терраформ провайдер брал его из переменных окружений.
	
</details>


<details>
    <summary>Ставим YC</summary>	

	vagrant@vagrant:~$ curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
	Downloading yc 0.92.0
	  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
									 Dload  Upload   Total   Spent    Left  Speed
	100 85.9M  100 85.9M    0     0  7723k      0  0:00:11  0:00:11 --:--:-- 8212k
	Yandex Cloud CLI 0.92.0 linux/amd64

	yc PATH has been added to your '/home/vagrant/.bashrc' profile
	yc bash completion has been added to your '/home/vagrant/.bashrc' profile.
	Now we have zsh completion. Type "echo 'source /home/vagrant/yandex-cloud/completion.zsh.inc' >>  ~/.zshrc" to install itTo complete installation, start a new shell (exec -l $SHELL) or type 'source "/home/vagrant/.bashrc"' in the current one
	vagrant@vagrant:~$ echo 'source /home/vagrant/yandex-cloud/completion.zsh.inc' >>  ~/.zshrc
	vagrant@vagrant:~$ source "/home/vagrant/.bashrc"
	vagrant@vagrant:~$ yc -v
	Yandex Cloud CLI 0.92.0 linux/amd64
</details> 

<details>
    <summary>Входим в CLI</summary>	 
не забываем подкючить в консоле оплаченый аккаунт.  

	vagrant@vagrant:~$ yc init
	Welcome! This command will take you through the configuration process.
	Pick desired action:
	 [1] Re-initialize this profile 'netologdz' with new settings
	 [2] Create a new profile
	Please enter your numeric choice: 1
	Please go to https://oauth.yandex.ru/authorize?response_type=token&client_id=KeyKeyKeyKey in order to obtain OAuth token.

	Please enter OAuth token: [Key]
	You have one cloud available: 'cloud-vagamutant' (id = KeyKeyKey). It is going to be used by default.
	Please choose folder to use:
	 [1] default (id = KeyKeyKey)
	 [2] Create a new folder
	Please enter your numeric choice: dz72
	Please enter a value between 1 and 2: 2
	Please enter a folder name: dz72
	Your current folder has been set to 'dz72' (id = KeyKeyKey).
	Do you want to configure a default Compute zone? [Y/n] y
	Which zone do you want to use as a profile default?
	 [1] ru-central1-a
	 [2] ru-central1-b
	 [3] ru-central1-c
	 [4] Don't set default zone
	Please enter your numeric choice: 1
	Your profile default Compute zone has been set to 'ru-central1-a'.


</details> 	
	
### Яндекс конфиг: 

	vagrant@vagrant:~$  yc config list
    token: KeyKeyKey
    cloud-id: b1g1q5rskild90n5b9n4
    folder-id: b1gq945akrsqbn63337t
    compute-default-zone: ru-central1-a


	
	
## Задача 2. Создание aws ec2 или yandex_compute_instance через терраформ.

<details>
    <summary>Задание 2</summary>

    В каталоге terraform вашего основного репозитория, который был создан в начале курсе, создайте файл main.tf и versions.tf.
    Зарегистрируйте провайдер
        для aws. В файл main.tf добавьте блок provider, а в versions.tf блок terraform с вложенным блоком required_providers. Укажите любой выбранный вами регион внутри блока provider.
        либо для yandex.cloud. Подробную инструкцию можно найти здесь.
    Внимание! В гит репозиторий нельзя пушить ваши личные ключи доступа к аккаунту. Поэтому в предыдущем задании мы указывали их в виде переменных окружения.
    В файле main.tf воспользуйтесь блоком data "aws_ami для поиска ami образа последнего Ubuntu.
    В файле main.tf создайте рессурс
        либо ec2 instance. Постарайтесь указать как можно больше параметров для его определения. Минимальный набор параметров указан в первом блоке Example Usage, но желательно, указать большее количество параметров.
        либо yandex_compute_image.
    Также в случае использования aws:
        Добавьте data-блоки aws_caller_identity и aws_region.
        В файл outputs.tf поместить блоки output с данными об используемых в данный момент:
            AWS account ID,
            AWS user ID,
            AWS регион, который используется в данный момент,
            Приватный IP ec2 инстансы,
            Идентификатор подсети в которой создан инстанс.
    Если вы выполнили первый пункт, то добейтесь того, что бы команда terraform plan выполнялась без ошибок.
</details>

### Вывод terraform plan:
<details>
    <summary>terraform plan</summary>	 

vagrant@vagrant:/vagrant/dz7_2/terraform$ terraform validate
Success! The configuration is valid.

vagrant@vagrant:/vagrant/dz7_2/terraform$ terraform plan

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # yandex_compute_image.ubuntu will be created
  + resource "yandex_compute_image" "ubuntu" {
      + created_at      = (known after apply)
      + folder_id       = (known after apply)
      + id              = (known after apply)
      + min_disk_size   = (known after apply)
      + name            = "ubuntu-2004-lts"
      + os_type         = (known after apply)
      + pooled          = (known after apply)
      + product_ids     = (known after apply)
      + size            = (known after apply)
      + source_disk     = (known after apply)
      + source_family   = (known after apply)
      + source_image    = "fd8qs44945ddtla09hnr"
      + source_snapshot = (known after apply)
      + source_url      = (known after apply)
      + status          = (known after apply)
    }

  # yandex_compute_instance.vm will be created
  + resource "yandex_compute_instance" "vm" {
      + created_at                = (known after apply)
      + folder_id                 = (known after apply)
      + fqdn                      = (known after apply)
      + hostname                  = "netologydz72.local"
      + id                        = (known after apply)
      + metadata                  = {
          + "ssh-keys" = <<-EOT
                ubuntu:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC8zTK0+EVlyXBtARmFlNTJcrBB8BoqlJKVHqqcEQyb+lzdzRPE6spVHtJW/qbvjlj9iqiWeoR57JcXwsI7H32muYy5qF7K4Nf+UsIM7JbjlB3rnE04ojO/zb2q4WvCgjZb5zFxA6oSRWIyguv7olnvDsRBY4fVLmJVEyG46MXABPzuGePe7GUhMYr5WJUXHNQ2E9rJHVIWpZCc/m/IB7bEtDMDJ3t+ec6QJeKCrl2aqAh2GL2VadYU8LoQypgGZQaoemaFa6EGmEscA8++hA9eEboIQMutMN1rwCtQAbcMinFzWUIxj6uzhPB0Ls8bOBGb4/MiBS7hVX+WSd148TNTg7BpTcjdAy1ofU8NBFBIPlTMzGBh+msIOQdVKhtdHjFyJAdYtzPnwBaPXNQ6n98FyMjnFRHEwcH3FGHIK15+6AsEtJx021JtbfYimxSK3f871Xpn/gVtPe6GqCn3OHSvHpJmj4N6IeRznhzK+/7zy6MUP3DIoOgukLVM0iwl2r8= vagrant@vagrant
            EOT
        }
      + name                      = "netologydz72"
      + network_acceleration_type = "standard"
      + platform_id               = "standard-v1"
      + service_account_id        = (known after apply)
      + status                    = (known after apply)
      + zone                      = (known after apply)

      + boot_disk {
          + auto_delete = true
          + device_name = (known after apply)
          + disk_id     = (known after apply)
          + mode        = (known after apply)

          + initialize_params {
              + block_size  = (known after apply)
              + description = (known after apply)
              + image_id    = (known after apply)
              + name        = (known after apply)
              + size        = 20
              + snapshot_id = (known after apply)
              + type        = "network-hdd"
            }
        }

      + network_interface {
          + index              = (known after apply)
          + ip_address         = (known after apply)
          + ipv4               = true
          + ipv6               = false
          + ipv6_address       = (known after apply)
          + mac_address        = (known after apply)
          + nat                = true
          + nat_ip_address     = (known after apply)
          + nat_ip_version     = (known after apply)
          + security_group_ids = (known after apply)
          + subnet_id          = (known after apply)
        }

      + placement_policy {
          + host_affinity_rules = (known after apply)
          + placement_group_id  = (known after apply)
        }

      + resources {
          + core_fraction = 100
          + cores         = 2
          + memory        = 2
        }

      + scheduling_policy {
          + preemptible = (known after apply)
        }
    }

  # yandex_vpc_network.net will be created
  + resource "yandex_vpc_network" "net" {
      + created_at                = (known after apply)
      + default_security_group_id = (known after apply)
      + folder_id                 = (known after apply)
      + id                        = (known after apply)
      + labels                    = (known after apply)
      + name                      = "networkdz72"
      + subnet_ids                = (known after apply)
    }

  # yandex_vpc_subnet.subnet will be created
  + resource "yandex_vpc_subnet" "subnet" {
      + created_at     = (known after apply)
      + folder_id      = (known after apply)
      + id             = (known after apply)
      + labels         = (known after apply)
      + name           = "subnet"
      + network_id     = (known after apply)
      + v4_cidr_blocks = [
          + "10.2.0.0/16",
        ]
      + v6_cidr_blocks = (known after apply)
      + zone           = "ru-central1-a"
    }

Plan: 4 to add, 0 to change, 0 to destroy.

─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you run "terraform apply" now.
	
</details>


### В качестве результата задания предоставьте:

    Вопрос: При помощи какого инструмента (из разобранных на прошлом занятии) можно создать свой образ ami?
    Ответ:  Образ можно создать с помощью Packer.        

Ссылка на репозиторий с исходной конфигурацией терраформа: [main.tf](https://github.com/Vaga999/netology-devops-2/blob/6c69129c313bdc1629a425e6063b26117a31c4cd/terraform/main.tf)

При попытке сделать terraform aplly вылазит:

	╷
	│ Error: Error while requesting API to create image: client-request-id = b0f1c5d3-a08c-4db4-b0e5-51660453a67a client-trace-id = 0bbfeb98-636f-4bf6-b38c-d2d037fdbc2f iam token create failed: server-request-id = a2793672-f9fd-4184-8542-979ea40f8aa3 server-trace-id = 47ba7769a52dcdeb:db72f4ca85efd264:47ba7769a52dcdeb:1 client-request-id = 6bd32b72-63ca-4832-86cd-80091cb77b78 client-trace-id = 0bbfeb98-636f-4bf6-b38c-d2d037fdbc2f rpc error: code = Unauthenticated desc = OAuth token is invalid or expired
	│
	│   with yandex_compute_image.ubuntu,
	│   on main.tf line 13, in resource "yandex_compute_image" "ubuntu":
	│   13: resource yandex_compute_image "ubuntu" {
	│
	╵
	╷
	│ Error: Error while requesting API to create network: client-request-id = da9fec95-8d60-4786-a584-e568556cb6aa client-trace-id = 0bbfeb98-636f-4bf6-b38c-d2d037fdbc2f iam token create failed: server-request-id = a2793672-f9fd-4184-8542-979ea40f8aa3 server-trace-id = 47ba7769a52dcdeb:db72f4ca85efd264:47ba7769a52dcdeb:1 client-request-id = 6bd32b72-63ca-4832-86cd-80091cb77b78 client-trace-id = 0bbfeb98-636f-4bf6-b38c-d2d037fdbc2f rpc error: code = Unauthenticated desc = OAuth token is invalid or expired
	│
	│   with yandex_vpc_network.net,
	│   on main.tf line 18, in resource "yandex_vpc_network" "net":
	│   18: resource "yandex_vpc_network" "net" {

Возможно это от отсутствия сервис акка.